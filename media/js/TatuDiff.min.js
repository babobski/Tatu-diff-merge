let inEdit=!1,TatuDiff={getEOL:eol=>{let $return="";switch(eol){case 2:$return="\r\n";break;case 1:$return="\n"}return $return},scrollToNext:()=>{let diffWindow,diffrences=document.getElementById("diffWindow").getElementsByClassName("difference");if(0===diffrences.length)return!1;currChange>=0&&TatuDiff.checkIfinBlock(diffrences[currChange]);for(var i=0;i<diffrences.length;i++)if(i>currChange){smoothScroll(diffrences[i]),currChange=i,TatuDiff.checkIfinBlock(diffrences[i]);break}TatuDiff.setAutoSelected(diffrences[currChange])},scrollToPrev:()=>{let diffWindow,diffrences=document.getElementById("diffWindow").getElementsByClassName("difference");if(0===diffrences.length)return!1;TatuDiff.checkIfinBlock(diffrences[currChange],"up");for(let i=diffrences.length;i>=0;i--)if(i<currChange){currChange=i,TatuDiff.checkIfinBlock(diffrences[i],"up");break}smoothScroll(diffrences[currChange]),TatuDiff.setAutoSelected(diffrences[currChange],"down")},scrollToRow:index=>{let trs=document.getElementsByTagName("tr");smoothScroll(trs[index-1])},checkIfinBlock:(el,direction="down")=>{if("down"===direction)for(;null!==el.nextElementSibling&&el.nextElementSibling.classList.contains("difference");)currChange++,el=el.nextElementSibling;else for(;null!==el.previousElementSibling&&el.previousElementSibling.classList.contains("difference");)currChange--,el=el.previousElementSibling},setAutoSelected:(el,direction="up")=>{if(TatuDiff.removeOtherSelected(),"down"===direction)for(el.classList.add("selected");null!==el.nextElementSibling&&el.nextElementSibling.classList.contains("difference");)(el=el.nextElementSibling).classList.add("selected");else for(el.classList.add("selected");null!==el.previousElementSibling&&el.previousElementSibling.classList.contains("difference");)(el=el.previousElementSibling).classList.add("selected");TatuDiff.enableButtons()},toggleEditable:el=>{let rightSide=el.children[3];"true"===rightSide.contentEditable?(rightSide.contentEditable="false",inEdit=!1):(rightSide.contentEditable="true",rightSide.addEventListener("focusout",e=>{TatuDiff.saveEditable(e.target)}),rightSide.focus(),inEdit=!0)},saveEditable:el=>{let saveTimeString=TatuDiff.getTimeString(),newVal=el.textContent,oldVal=el.dataset.text,index=el.parentNode.rowIndex-1,language=el.dataset.lang;if(newVal===oldVal){if(useHighlight){let text=hljs.highlight(oldVal,{language:language}).value;el.innerHTML=text}return inEdit=!1,!1}let text=useHighlight?hljs.highlight(newVal,{language:language}).value:newVal;el.parentNode.classList.add("saved"),mergeResult[index]=newVal,el.dataset.text=newVal,el.contentEditable="false",inEdit=!1,el.innerHTML=text,History.push({line:index,action:"edit",time:saveTimeString,oldval:oldVal}),TatuDiff.toggleHistoryBtn()},saveEditableOnKeypress:()=>{let tds=document.getElementsByTagName("td");for(let i=0;i<tds.length;i++){const el=tds[i];if("true"===el.contentEditable){TatuDiff.saveEditable(el);break}}},refreshHighLight:e=>{let el=e.target,text=el.textContent,language=el.dataset.lang,caretPos=TatuDiff.getCaretPosition(el);text=hljs.highlight(text,{language:language}).value,el.innerHTML=text,TatuDiff.setCaret(el,caretPos)},setCaret:(node,pos)=>{var range=document.createRange(),sel=window.getSelection();let childs=node.childNodes,currLeng=0,currNode="";for(let i=0;i<childs.length;i++){const child=childs[i];let childLength=child.length?child.length:child.textContent.length;if(pos<=currLeng+childLength){currNode=i;break}currLeng+=childLength}let offset=pos-currLeng,nodeToSet=node.childNodes[currNode],newData=TatuDiff.getCorrectNode(nodeToSet,offset);nodeToSet=newData.node,offset=newData.offset,range.setStart(nodeToSet,offset),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range),node.focus()},getCorrectNode:(node,offset)=>{if(nodeTextTypes=[3,4,7,8],-1!==nodeTextTypes.indexOf(node.nodeType)&&node.length>=offset)return{node:node,offset:offset};if(1===node.childElementCount&&-1!==nodeTextTypes.indexOf(node.firstChild.nodeType)&&node.firstChild.length>=offset)return{node:node.firstChild,offset:offset};let children=node.childNodes;for(let i=0;i<children.length;i++){const child=children[i];let childLength=child.length?child.length:child.textContent.length;if(offset<=childLength)return-1!==nodeTextTypes.indexOf(child.nodeType)&&node.length>=offset?{node:child,offset:offset}:1===child.childElementCount&&-1!==nodeTextTypes.indexOf(child.firstChild.nodeType)&&node.firstChild.length>=offset?{node:child.firstChild,offset:offset}:TatuDiff.getCorrectNode(child,offset);offset-=childLength}return null},getCaretPosition:element=>{let position=0;const isSupported=void 0!==window.getSelection;if(isSupported){const selection=window.getSelection();if(0!==selection.rangeCount){const range=window.getSelection().getRangeAt(0),preCaretRange=range.cloneRange();preCaretRange.selectNodeContents(element),preCaretRange.setEnd(range.endContainer,range.endOffset),position=preCaretRange.toString().length}}return position},setClickFunctions:()=>{let table,trs=document.getElementById("diff").getElementsByTagName("tr");for(let i=0;i<trs.length;i++)trs[i].onclick=e=>{if(!inEdit){e.preventDefault();let target=TatuDiff.getRow(e.target);TatuDiff.setSelect(target,e.shiftKey)}},trs[i].ondblclick=e=>{if(e.preventDefault(),!inEdit){let target=TatuDiff.getRow(e.target);TatuDiff.toggleEditable(target)}},trs[i].oninput=e=>{useHighlight&&TatuDiff.refreshHighLight(e)},trs[i].onanimationend=e=>{e.target.classList.remove("saved")}},setSelect:(el,shift)=>{shift?null!==lastSelected&&(TatuDiff.removeOtherSelected(),TatuDiff.selectBlock(el,lastSelected),TatuDiff.enableButtons()):el.classList.contains("selected")?TatuDiff.inBlockSelect()?(TatuDiff.removeOtherSelected(),el.classList.add("selected"),lastSelected=el,TatuDiff.enableButtons()):(TatuDiff.removeOtherSelected(),lastSelected=null,TatuDiff.disableButtons()):(TatuDiff.removeOtherSelected(),el.classList.add("selected"),lastSelected=el,TatuDiff.enableButtons())},selectBlock:(el,lastSelected)=>{let trs=document.getElementsByTagName("tr"),inSelect=!1,addEnd=!1;for(let i=0;i<trs.length;i++)trs[i]===lastSelected?(inSelect&&!addEnd&&(addEnd=!0),inSelect||(inSelect=!0)):trs[i]===el&&(inSelect&&!addEnd&&(el.classList.add("selected"),addEnd=!0),inSelect||(inSelect=!0)),inSelect&&!addEnd&&trs[i].classList.add("selected")},inBlockSelect:()=>(selectedLines=document.getElementsByClassName("selected"),selectedLines.length>1),removeOtherSelected:()=>{let trs=document.getElementsByTagName("tr");for(let i=0;i<trs.length;i++)trs[i].classList.contains("selected")&&trs[i].classList.remove("selected")},copySelected:()=>{let result="",selectedLines=document.getElementsByClassName("selected"),addEOL=selectedLines.length-1;for(let i=0;i<selectedLines.length;i++){let leftResult;result+=selectedLines[i].children[1].dataset.text,addEOL>0&&(result+=TatuDiff.getEOL(EOL),addEOL--)}clipboard.set(result)},mergeLines:selectedLines=>{let mergeTimeString=TatuDiff.getTimeString();for(let i=0;i<selectedLines.length;i++){let selectedLine=selectedLines[i],index=selectedLine.rowIndex-1,replaceWith="",replaceWithText="",children=selectedLine.children,emptyLine=!1;History.push({line:index,action:"merge",time:mergeTimeString}),selectedLine.classList.add("merged");let last=!1;for(let e=0;e<children.length;e++)"TD"===children[e].nodeName&&(last?(children[e].innerHTML=replaceWith,children[e].dataset.text=replaceWithText):(replaceWith=children[e].innerHTML,replaceWithText=children[e].dataset.text,children[e].classList.contains("empty")&&(emptyLine=!0)),last=!0);emptyLine&&selectedLine.classList.add("empty"),mergeResult[index]=leftLines[index]}TatuDiff.toggleHistoryBtn(),TatuDiff.disableButtons()},deleteLines:selectedLines=>{let deleteTimeString=TatuDiff.getTimeString();for(let i=0;i<selectedLines.length;i++){let selectedLine=selectedLines[i],index=selectedLine.rowIndex-1;History.push({line:index,action:"remove",time:deleteTimeString}),selectedLine.classList.add("empty"),mergeResult[index]="@empty@"}TatuDiff.toggleHistoryBtn(),TatuDiff.disableButtons()},mergeSelected:()=>{selectedLines=document.getElementsByClassName("selected"),selectedLines.length>0&&TatuDiff.mergeLines(selectedLines)},deleteSelected:()=>{selectedLines=document.getElementsByClassName("selected"),selectedLines.length>0&&TatuDiff.deleteLines(selectedLines)},getResult:()=>{let result="";for(let i=0;i<mergeResult.length;i++)"@empty@"!==mergeResult[i]&&(result+=mergeResult[i],i!==mergeResult.length-1&&(result+=TatuDiff.getEOL(EOL)));return result},copyResult:()=>{let result=TatuDiff.getResult();vscode.postMessage({command:"copy_result",text:result})},saveResult:()=>{let result=TatuDiff.getResult();vscode.postMessage({command:"save_result",text:result})},closeWindow:()=>{vscode.postMessage({command:"close_window"})},openInfoWindow:()=>{let infoWindow=document.getElementById("info_window");infoWindow.classList.contains("open")?infoWindow.classList.remove("open"):infoWindow.classList.add("open")},closeInfoWindow:()=>{let infoWindow;document.getElementById("info_window").classList.remove("open")},historyBack:()=>{if(0===History.length)return!1;let backStep=History.pop(),index=parseInt(backStep.line),time=backStep.time,trs=document.getElementsByTagName("tr");for(let i=0;i<trs.length;i++)if(trs[i].rowIndex-1===index)switch(backStep.action){case"merge":TatuDiff.handleBackWardsMerge(trs[i],index),mergeResult[index]=rightLines[index];break;case"remove":trs[i].classList.remove("empty"),mergeResult[index]=rightLines[index];break;case"edit":TatuDiff.handleBackWardsEdit(trs[i],index,backStep)}History.length>0&&History[History.length-1].time===time?TatuDiff.historyBack():(TatuDiff.scrollToRow(index),TatuDiff.toggleHistoryBtn())},handleBackWardsEdit(row,index,backStep){let cells=row.children,editCell=cells[3],language=cells[3].dataset.lang,text=backStep.oldval;useHighlight&&(text=hljs.highlight(text,{language:language}).value),editCell.innerHTML=text,editCell.dataset.text=backStep.oldval,mergeResult[index]=backStep.oldval},handleBackWardsMerge:(row,index)=>{let cells=row.children,last=!1;row.classList.remove("merged");for(let e=0;e<cells.length;e++)if("TD"===cells[e].nodeName){if(last){if("@empty@"===rightLines[index])cells[e].innerHTML="";else{let rightContent=rightLines[index].replace(/\t/g,"    ");cells[e].dataset.text=rightContent,useHighlight&&(rightContent=hljs.highlight(rightContent,{language:cells[e].dataset.lang}).value),cells[e].innerHTML=rightContent,row.classList.remove("empty")}mergeResult[index]=rightLines[index]}last=!0}},getRow:el=>{let currEl=el;if("TR"===currEl.nodeName)return currEl;for(;"TR"!==currEl.nodeName;)currEl=currEl.parentNode;return currEl},getTimeString:()=>{let date=new Date;return date.getDay().toString()+date.getHours().toString()+date.getMinutes().toString()+date.getSeconds().toString()+date.getMilliseconds().toString()},enableButtons:()=>{let mergeLines=document.getElementById("merge_lines"),deleteLines=document.getElementById("delete_lines");mergeLines.disabled=!1,deleteLines.disabled=!1},disableButtons:()=>{let mergeLines=document.getElementById("merge_lines"),deleteLines=document.getElementById("delete_lines");mergeLines.disabled=!0,deleteLines.disabled=!0},toggleHistoryBtn:()=>{let undoBtn=document.getElementById("undo");History.length>0&&undoBtn.disabled?undoBtn.disabled=!1:0===History.length&&(undoBtn.disabled=!0)},keyDownHandler:event=>{(67===event.keyCode&&event.ctrlKey||67===event.keyCode&&event.metaKey)&&(event.preventDefault(),TatuDiff.copySelected()),!event.ctrlKey&&!event.metaKey||83!==event.keyCode||inEdit||(event.preventDefault(),TatuDiff.saveResult()),40!==event.keyCode||event.shiftKey||(event.preventDefault(),TatuDiff.scrollToNext()),38!==event.keyCode||event.shiftKey||(event.preventDefault(),TatuDiff.scrollToPrev()),39!==event.keyCode||event.shiftKey||inEdit||(event.preventDefault(),TatuDiff.mergeSelected()),8!==event.keyCode||event.shiftKey||inEdit||(event.preventDefault(),TatuDiff.deleteSelected()),27!==event.keyCode||event.shiftKey||(event.preventDefault(),TatuDiff.closeWindow()),90!==event.keyCode||!event.ctrlKey&&!event.metaKey||inEdit||(event.preventDefault(),TatuDiff.historyBack()),13===event.keyCode&&inEdit&&(event.preventDefault(),TatuDiff.saveEditableOnKeypress())},setButtonListners:()=>{let scrollToPrev=document.getElementById("scroll_to_prev"),scrollToNext=document.getElementById("scroll_to_next"),mergeLines=document.getElementById("merge_lines"),deleteLines=document.getElementById("delete_lines"),undo=document.getElementById("undo"),copyResult=document.getElementById("copy_result"),saveResult=document.getElementById("save_result"),info=document.getElementById("info"),closeInfo=document.getElementById("close_info"),closeWindow=document.getElementById("close_window");scrollToPrev.addEventListener("click",TatuDiff.scrollToPrev),scrollToNext.addEventListener("click",TatuDiff.scrollToNext),mergeLines.addEventListener("click",TatuDiff.mergeSelected),deleteLines.addEventListener("click",TatuDiff.deleteSelected),undo.addEventListener("click",TatuDiff.historyBack),copyResult.addEventListener("click",TatuDiff.copyResult),saveResult.addEventListener("click",TatuDiff.saveResult),info.addEventListener("click",TatuDiff.openInfoWindow),closeInfo.addEventListener("click",TatuDiff.closeInfoWindow),closeWindow.addEventListener("click",TatuDiff.closeWindow)}};window.addEventListener("keydown",event=>{TatuDiff.keyDownHandler(event)});